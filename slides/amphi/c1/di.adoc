== Injection de dépendances

image:di_everywhere.webp[]

[.columns]
== Injection de dépendances

[.column]
[mermaid]
----
%%{init: { 'logLevel': 'debug', 'theme': 'dark'} }%%
classDiagram
    direction TD
    class AService {
        <<class>>
        +findAll()
    }
    class PostgresDb {
        <<class>>
        +findAllInDb()
    }
    AService ..> PostgresDb
----

[.column]
[source,kotlin]
----
class AService() {
    val db = PostgresDb()

    fun findAll() = db.findAllInDb()
}
----

[.columns]
== Injection de dépendances

[.column]
[mermaid]
----
%%{init: { 'logLevel': 'debug', 'theme': 'dark'} }%%
classDiagram
    direction TD
    class AService {
        <<class>>
        +findAll()
    }
    class MySqlDb {
        <<class>>
        +findAllInDb()
    }
    class PostgresDb {
        <<class>>
        +findAllInDb()
    }
    AService ..> PostgresDb
    AService ..> MySqlDb
----

[.column]
[source,kotlin]
----
class AService() {
  val pg = PostgresDb()
  val my = MySqlDb()

  fun findAll(pg: Boolean) = if(pg) {
    db.findAllInDb()
  } else {
    my.findAllInDb()
  }
}
----

[.columns]
== Injection de dépendances

[.column]
[mermaid]
----
%%{init: { 'logLevel': 'debug', 'theme': 'dark'} }%%
classDiagram
    direction TD
    class AService {
        <<class>>
        +findAll()
    }
    class DbAccess {
        <<interface>>
        +findAllInDb()
    }
    class PostgresDb {
        <<class>>
    }
    class MySqlDb {
        <<class>>
    }
    AService ..> DbAccess
    DbAccess <|.. PostgresDb
    DbAccess <|.. MySqlDb
----

[.column]
[source,kotlin]
----
class AService(val db: DbAccess) {}
  fun findAll() = db.findAllInDb()
}

interface DbAccess {
  fun findAll() = TODO()
}

class PostgresDb(): DbAccess {
  override fun findAll() = TODO()
}

class MySqlDb(): DbAccess{
  override fun findAll() = TODO()
}
----

== Injection de dépendances

[fragment, step=1]
[source,kotlin]
----
val appPg = AService(PostgresDb())
----

[fragment, step=2]
[source,kotlin]
----
val appMy = AService(MySqlDb())
----

[transition=slide-in]
== Beans

[source,kotlin]
----
@Configuration
class MyConfig {








}
----

[transition=fade-in]
== Beans

[source,kotlin]
----
@Configuration
class MyConfig {
    @Bean
    fun myDb() = PostgresDb()






}
----


[transition=fade-in]
== Beans

[source,kotlin]
----
@Configuration
class MyConfig {
    @Bean
    fun myDb() = PostgresDb()

    @Bean
    fun aService(dbAccess: DbAccess) = AService(dbAccess)



}
----

[transition=fade-in]
== Beans

[source,kotlin]
----
@Configuration
class MyConfig {
    @Bean
    fun myDb() = PostgresDb()

    @Bean
    fun aService(dbAccess: DbAccess) = AService(dbAccess)

    @Bean
    fun another(dbAccess: DbAccess) = Other(myDb())
}
----

[transition=fade-in]
== External Beans

[source,kotlin]
----
@Configuration
class MyConfig {
    @Bean
    fun myDb(aDriverFromALib: JdbcDriver) = GenericDb(aDriverFromALib)

    @Bean
    fun aService(dbAccess: DbAccess) = AService(dbAccess)

    @Bean
    fun another(dbAccess: DbAccess) = Other(myDb())
}
----

== Application Context

[source,kotlin]
----
fun main() {
  val context: ApplicationContext = 
     AnnotationConfigApplicationContext(MyConfig::class.java)


}
----

[transition=fade-out]
== Application Context

[source,kotlin]
----
fun main() {
  val context: ApplicationContext = 
     AnnotationConfigApplicationContext(MyConfig::class.java)
  val service = context.getBean(AService::class.java)

}
----

[transition=fade-out]
== Application Context

[source,kotlin]
----
fun main() {
  val context: ApplicationContext = 
     AnnotationConfigApplicationContext(MyConfig::class.java)
  val service = context.getBean(AService::class.java)
  service.findAllInDb()
}
----

== Scope

[source,kotlin]
----
@Configuration
class MyConfig {
    @Bean
    fun myDb(aDriverFromALib: JdbcDriver) = GenericDb(aDriverFromALib)

    @Bean
    fun aService(dbAccess: DbAccess) = AService(dbAccess)

    @Bean
    fun another(dbAccess: DbAccess) = Other(myDb())
}
----

aService.dbAccess == another.dbAccess

[transition=fade-out]
== Scope

[source,kotlin]
----
@Configuration
class MyConfig {
    @Bean @Scope(BeanDefinition.SCOPE_SINGLETON)
    fun myDb(aDriverFromALib: JdbcDriver) = GenericDb(aDriverFromALib)

    @Bean @Scope(BeanDefinition.SCOPE_SINGLETON)
    fun aService(dbAccess: DbAccess) = AService(dbAccess)

    @Bean @Scope(BeanDefinition.SCOPE_SINGLETON)
    fun another(dbAccess: DbAccess) = Other(myDb())
}
----

aService.dbAccess == another.dbAccess

[transition=fade-out]
== Scope

[source,kotlin]
----
@Configuration
class MyConfig {
    @Bean @Scope(BeanDefinition.SCOPE_PROTOTYPE)
    fun myDb(aDriverFromALib: JdbcDriver) = GenericDb(aDriverFromALib)

    @Bean
    fun aService(dbAccess: DbAccess) = AService(dbAccess)

    @Bean
    fun another(dbAccess: DbAccess) = Other(myDb())
}
----

aService.dbAccess != another.dbAccess

== Scope

Singleton -> un unique bean

Prototype -> un bean par instance d'objet

== Web-aware Scope

Request -> un bean pour la durée de vie de la requête HTTP

Session -> un bean pour la durée de la session HTTP

Application -> un bean pour la durée de vie de la servlet 

WebSocket -> un bean pour la durée de vie de la WebSocket

[transition=fade-out]
== Autowired

[source,kotlin]
----
//
class RestController {
    @Autowired
    lateinit var aService: AService
}
----

[.hideCode]
[source,kotlin]
----
@Service
class RestController(val aService: AService)
----

[transition=fade-in]
== Autowired

[source,kotlin]
----
@Service
class RestController {
    @Autowired
    lateinit var aService: AService
}
----

[fragment, step=1]
[source,kotlin]
----
@Service
class RestController(val aService: AService)
----

[transition=fade-in]
== Autowired

[source,kotlin]
----
@Service
class RestController {
    @Autowired
    lateinit var aService: AService
}
----

[source,kotlin]
----
@Service // @Component @Repository ...
class RestController(val aService: AService)
----
